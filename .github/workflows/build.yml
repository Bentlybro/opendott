name: Build OpenDOTT Firmware

on:
  push:
    branches: [main, master]
    paths:
      - 'firmware/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'firmware/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

env:
  ZEPHYR_SDK_VERSION: 0.16.8
  ZEPHYR_VERSION: v3.7.0

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: workspace

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ninja-build gperf ccache dfu-util \
            device-tree-compiler wget xz-utils file \
            make gcc gcc-multilib g++-multilib
          pip install west pyelftools

      - name: Install Zephyr SDK
        run: |
          cd ~
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64_minimal.tar.xz
          tar xf zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64_minimal.tar.xz
          cd zephyr-sdk-${ZEPHYR_SDK_VERSION}
          ./setup.sh -t arm-zephyr-eabi -h -c

      - name: Initialize Zephyr workspace
        working-directory: workspace
        run: |
          west init -l firmware
          west update --narrow -o=--depth=1

      - name: Install Zephyr Python deps
        working-directory: workspace
        run: |
          pip install -r zephyr/scripts/requirements.txt

      - name: Build firmware
        working-directory: workspace
        run: |
          west build -b opendott firmware -- -DBOARD_ROOT=${{ github.workspace }}/workspace/firmware -DDTS_ROOT=${{ github.workspace }}/workspace/firmware

      - name: Create MCUboot DFU image
        run: |
          pip install imgtool
          cd workspace/build/zephyr
          # Create unsigned MCUboot image (header-size 0x200, slot-size matches DTS)
          imgtool create --version 1.0.0 --header-size 0x200 --slot-size 0x72000 --align 4 zephyr.bin zephyr_dfu.bin

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opendott-firmware
          path: |
            workspace/build/zephyr/zephyr.bin
            workspace/build/zephyr/zephyr.hex
            workspace/build/zephyr/zephyr.elf
            workspace/build/zephyr/zephyr.map
            workspace/build/zephyr/zephyr_dfu.bin
          if-no-files-found: error
